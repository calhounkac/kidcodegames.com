<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixel Racer 2089</title>
  <style>
    :root{
      --bg:#0b0e1a; --grid:#12203a; --cyan:#29f0ff; --mag:#ff2bdd; --gold:#ffd43b; --white:#e9f1ff; --red:#ff5b6e; --green:#7CFF7A;
    }
    html,body{height:100%}
    body{margin:0; background: radial-gradient(1200px 600px at 50% 105%, #0d1330 0%, var(--bg) 60%);
         color:var(--white); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
         display:flex; flex-direction:column; align-items:center; gap:8px; user-select:none;}
    header{text-align:center}
    h1{margin:6px 0 0; font-weight:800; letter-spacing:.06em; text-transform:uppercase; font-size:clamp(20px,3.4vw,36px)}
    .subtitle{opacity:.8; font-size:clamp(12px,1.8vw,14px); letter-spacing:.2em; text-transform:uppercase}

    #gameWrap{ display:grid; grid-template-columns:minmax(260px,360px) 1fr; align-items:start; gap:12px; width:min(96vw, 1700px); }
    .hud{ grid-column:1; grid-row:1; display:flex; flex-direction:column; gap:8px; padding:8px 10px; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
    .pill{ background:#ffffff14; border:1px solid #ffffff20; padding:6px 10px; border-radius:999px; backdrop-filter:blur(6px); font-size:12px; }
    .controls{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }

    .menu{ grid-column:1; grid-row:2; display:block; background:transparent; }
    .panel{ width:100%; background:#0e1328e6; border:1px solid #2b3567; box-shadow:0 10px 60px #000; padding:16px; border-radius:16px; }
    .panel h2{ margin:0 0 10px; letter-spacing:.12em; text-transform:uppercase; font-size:clamp(16px,2.2vw,22px); }
    .panel p{ margin:8px 0; opacity:.85; }
    .options{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
    button{ appearance:none; border:1px solid #3e58a4; background:linear-gradient(180deg,#172146,#0e1531); color:var(--white); font-weight:700; border-radius:12px; padding:12px 14px; cursor:pointer; text-transform:uppercase; letter-spacing:.08em; }
    button:hover{ filter:brightness(1.12) }
    .b-cyan{ box-shadow:0 0 0 2px #00eaff55 inset, 0 0 18px #00eaff22; }
    .b-mag{ box-shadow:0 0 0 2px #ff2bdd55 inset, 0 0 18px #ff2bdd22; }
    .tiny{ font-size:11px; opacity:.8 }

    canvas{ image-rendering:pixelated; background:repeating-linear-gradient(0deg,var(--grid) 0 2px, transparent 2px 20px),
                                   repeating-linear-gradient(90deg,var(--grid) 0 2px, transparent 2px 20px),
                                   linear-gradient(#0a0f1f,#080b16);
             box-shadow:0 0 24px #0ff3 inset, 0 0 30px #0a96ff25, 0 10px 40px #0008; border-radius:14px; grid-column:2; grid-row:2; margin-top:-8px; }

    .overlay{ position:fixed; inset:0; display:grid; place-items:center; pointer-events:none; }
    .overlay .panel{ pointer-events:auto; background:#0e1328cc; width:min(92vw,560px); }

    .scorebar{ grid-column:2; grid-row:1; display:flex; justify-content:center; gap:12px; padding:6px 10px; }

    @media (max-width: 920px){
      #gameWrap{ grid-template-columns: 1fr; }
      canvas{ grid-column:1; grid-row:auto }
    }
  </style>
</head>
<body>
  <header>
    <div class="subtitle">Neon Grid • Energy Barriers • Instant Turns</div>
    <h1>Pixel Racer 2089</h1>
  </header>
  <div id="gameWrap">
    <div class="hud">
      
      </div>
    </div>
    <div id="scorebar" class="scorebar">Score — P1: <b id="p1sTop">0</b> • P2: <b id="p2sTop">0</b></div>

    <canvas id="game" width="1280" height="800" aria-label="Pixel Racer 2089"></canvas>

    <div id="menu" class="menu" role="dialog" aria-modal="true">
      <div class="panel">
        <h2>Choose a Mode</h2>
        <div class="options">
          <button id="start1" class="b-cyan">Single Player vs AI</button>
          <button id="start2" class="b-mag">Two Players (Local)</button>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="pill">
            <button id="fitBtn" class="b-cyan" style="margin-right:8px;">Fit: On</button>
            <label class="tiny">Zoom <input id="zoomRange" type="range" min="0.5" max="2" step="0.05" value="1" style="vertical-align:middle"></label>
          </div>
        </div>
      </div>
    </div>
    </div>
    </div>
  </div>

  <script>
  (()=>{
    const canvas=document.getElementById('game');
    const ctx=canvas.getContext('2d');
    const P1S=document.getElementById('p1s');
    const P2S=document.getElementById('p2s');
    const P1T=document.getElementById('p1sTop');
    const P2T=document.getElementById('p2sTop');
    const menu=document.getElementById('menu');
    const start1=document.getElementById('start1');
    const start2=document.getElementById('start2');

    // Fit/Zoom controls
    const fitBtn = document.getElementById('fitBtn');
    const zoomRange = document.getElementById('zoomRange');
    let fitToWindow = true; let zoom = 1;

    const CELL=10, COLS=Math.floor(canvas.width/CELL), ROWS=Math.floor(canvas.height/CELL);
    let running=false,paused=false,vsAI=true,intermission=false;
    let tickMs=60,lastTime=0,acc=0;

    const board=new Uint8Array(COLS*ROWS);const idx=(x,y)=>y*COLS+x;
    function resetBoard(){board.fill(0);}

    function glow(c,a=16){ctx.shadowBlur=a;ctx.shadowColor=c;ctx.strokeStyle=c;ctx.fillStyle=c;}

    function makePlayer(x,y,dir,col,id){return{x,y,dir,pending:null,color:col,trailId:id,alive:true,score:0,barrierCd:0}};
    let p1=makePlayer(5,Math.floor(ROWS/2),'right',getComputedStyle(document.documentElement).getPropertyValue('--cyan').trim(),1);
    let p2=makePlayer(COLS-6,Math.floor(ROWS/2),'left',getComputedStyle(document.documentElement).getPropertyValue('--mag').trim(),2);

    const DIRS={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]};

    function centerPlayers(){p1.x=5;p1.y=Math.floor(ROWS/2);p1.dir='right';p1.alive=true;p1.pending=null;p1.barrierCd=0;p2.x=COLS-6;p2.y=Math.floor(ROWS/2);p2.dir='left';p2.alive=true;p2.pending=null;p2.barrierCd=0;board[idx(p1.x,p1.y)]=p1.trailId;board[idx(p2.x,p2.y)]=p2.trailId;}

    const barriers=new Set();let barrierTimer=0;
    function spawnBarrier(){for(let i=0;i<30;i++){const x=2+Math.floor(Math.random()*(COLS-4)),y=2+Math.floor(Math.random()*(ROWS-4)),idc=idx(x,y);if(board[idc]===0&&!barriers.has(idc)){barriers.add(idc);return;}}}

    function dropBarrierInFront(pl){if(pl.barrierCd>0)return;const[dx,dy]=DIRS[pl.dir];const bx=pl.x+dx,by=pl.y+dy;if(bx>=0&&bx<COLS&&by>=0&&by<ROWS){const idc=idx(bx,by);if(board[idc]===0&&!barriers.has(idc)){barriers.add(idc);pl.barrierCd=25;}}}

    const keys=new Set();window.addEventListener('keydown',e=>{keys.add(e.code);if(e.code==='KeyR')startRound();if(e.code==='KeyP')paused=!paused;if(e.code==='Digit1'){vsAI=true;startGame();}if(e.code==='Digit2'){vsAI=false;startGame();}if(e.code==='KeyB')dropBarrierInFront(p1);if(e.code==='KeyF')toggleFit();});window.addEventListener('keyup',e=>keys.delete(e.code));

    function setDir(pl,d){pl.pending=d;}
    function pollInput(){if(keys.has('ArrowUp'))setDir(p1,'up');if(keys.has('ArrowDown'))setDir(p1,'down');if(keys.has('ArrowLeft'))setDir(p1,'left');if(keys.has('ArrowRight'))setDir(p1,'right');if(!vsAI){if(keys.has('KeyW'))setDir(p2,'up');if(keys.has('KeyS'))setDir(p2,'down');if(keys.has('KeyA'))setDir(p2,'left');if(keys.has('KeyD'))setDir(p2,'right');}}
    function applyDir(pl){if(!pl.pending)return;pl.dir=pl.pending;pl.pending=null;}

    function aiChoose(){const dirs=['up','down','left','right'];let best=p2.dir,bestLen=-1;for(const d of dirs){const l=lookaheadLen(p2.x,p2.y,d,50);if(l>bestLen){bestLen=l;best=d;}}const[dx,dy]=DIRS[best];const nx=p2.x+dx,ny=p2.y+dy;if(!isSafeCell(nx,ny)){const[cdx,cdy]=DIRS[p2.dir];const cx=p2.x+cdx,cy=p2.y+cdy;if(isSafeCell(cx,cy))return;}setDir(p2,best);}
    function lookaheadLen(x,y,d,m){const[dx,dy]=DIRS[d];let n=0,cx=x,cy=y;while(n<m){cx+=dx;cy+=dy;if(!isSafeCell(cx,cy))break;n++;}return n;}
    function isSafeCell(x,y){if(x<0||x>=COLS||y<0||y>=ROWS)return false;const idc=idx(x,y);return board[idc]===0&&!barriers.has(idc);}

    function startGame(){menu.style.display='none';resetBoard();centerPlayers();barriers.clear();barrierTimer=0;running=true;paused=false;intermission=false;lastTime=performance.now();acc=0;requestAnimationFrame(loop);}
    start1.onclick=()=>{vsAI=true;startGame();};start2.onclick=()=>{vsAI=false;startGame();};

    function startRound(){resetBoard();centerPlayers();}

    function step(){if(!running||paused||intermission)return;pollInput();if(vsAI&&p2.alive)aiChoose();applyDir(p1);applyDir(p2);if(p1.barrierCd>0)p1.barrierCd--;if(p2.barrierCd>0)p2.barrierCd--;barrierTimer++;if(barrierTimer%30===0&&barriers.size<200)spawnBarrier();movePlayer(p1);movePlayer(p2);const alive=(p1.alive?1:0)+(p2.alive?1:0);if(alive<=1){if(alive===1){if(p1.alive){p1.score++;updateHUD();flashWin(p1.color,'P1 scores!');}else{p2.score++;updateHUD();flashWin(p2.color,vsAI?'AI scores!':'P2 scores!');}}else{flashWin('#9aa6ff','Double crash!');}intermission=true;setTimeout(()=>{startRound();intermission=false;},700);}if(p1.score>=5||p2.score>=5){running=false;setTimeout(()=>{menu.style.display='block';menu.querySelector('.panel').innerHTML=`<h2>Champion: ${p1.score>p2.score?'P1':'P2/AI'}</h2><p>Final Score — P1: <b>${p1.score}</b> • ${vsAI?'AI':'P2'}: <b>${p2.score}</b></p><div class='options'><button id='again1' class='b-cyan'>Play Again: Single</button><button id='again2' class='b-mag'>Play Again: Two</button></div>`;document.getElementById('again1').onclick=()=>{vsAI=true;p1.score=p2.score=0;startGame();};document.getElementById('again2').onclick=()=>{vsAI=false;p1.score=p2.score=0;startGame();};},800);}}

    function movePlayer(pl){if(!pl.alive)return;const[dx,dy]=DIRS[pl.dir];const nx=pl.x+dx,ny=pl.y+dy;if(!isSafeCell(nx,ny)){pl.alive=false;crashFx(pl);return;}board[idx(pl.x,pl.y)]=pl.trailId;pl.x=nx;pl.y=ny;}

    function crashFx(pl){ctx.save();const cx=pl.x*CELL+CELL/2,cy=pl.y*CELL+CELL/2;const g=ctx.createRadialGradient(cx,cy,0,cx,cy,40);g.addColorStop(0,pl.color);g.addColorStop(1,'#0000');ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.restore();}

    function flashWin(c,t){const o=document.createElement('div');o.className='overlay';const i=document.createElement('div');i.className='panel';i.innerHTML=`<h2 style='color:${c}'>${t}</h2>`;o.appendChild(i);document.body.appendChild(o);setTimeout(()=>o.remove(),500);}

    function updateHUD(){ if(P1S) P1S.textContent=p1.score; if(P2S) P2S.textContent=p2.score; if(P1T) P1T.textContent=p1.score; if(P2T) P2T.textContent=p2.score; }

    function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);for(let y=0;y<ROWS;y++){for(let x=0;x<COLS;x++){const v=board[idx(x,y)];if(v!==0){const color=(v===1)?p1.color:(v===2?p2.color:'#666');drawCell(x,y,color,0.75);}}}glow('#7bf3ff',8);barriers.forEach(i=>{const x=i%COLS,y=Math.floor(i/COLS);drawCell(x,y,'#7bf3ff',0.9,true);});drawLightBike(p1);drawLightBike(p2);ctx.save();glow('#00eaff',20);ctx.lineWidth=4;ctx.strokeRect(2,2,canvas.width-4,canvas.height-4);ctx.restore();}

    function drawCell(x,y,c,a=1,b=false){ctx.save();const px=x*CELL,py=y*CELL,p=1;ctx.globalAlpha=a;ctx.fillStyle=c;ctx.fillRect(px+p,py+p,CELL-p*2,CELL-p*2);if(b){ctx.globalAlpha=.5;ctx.fillRect(px+2,py+2,CELL-4,CELL-4);}ctx.restore();}

    function drawLightBike(pl){if(!pl.alive)return;const [dx,dy]=DIRS[pl.dir];const cx=pl.x*CELL+CELL/2,cy=pl.y*CELL+CELL/2;ctx.save();ctx.translate(cx,cy);ctx.rotate(Math.atan2(dy,dx));ctx.fillStyle=pl.color;ctx.beginPath();ctx.moveTo(5,0);ctx.lineTo(-3,3);ctx.lineTo(-3,-3);ctx.closePath();ctx.fill();ctx.fillRect(-3,-2,3,4);ctx.restore();}

    function loop(t){if(!running)return;const dt=t-lastTime;lastTime=t;acc+=dt;while(acc>=tickMs){step();acc-=tickMs;}draw();requestAnimationFrame(loop);}

    resetBoard();centerPlayers();menu.style.display='block';

    // Fit logic reserves sidebar width when present
    function fit(){
      const sideActive = window.innerWidth >= 980; const sideW = sideActive ? 360 : 0;
      const maxW = Math.min(window.innerWidth - sideW - 28, 1600);
      const maxH = Math.min(window.innerHeight - 170, 900);
      const raw = Math.min(maxW/canvas.width, maxH/canvas.height);
      const scale = fitToWindow ? raw : zoom;
      const clamped = Math.max(0.3, Math.min(scale, 3));
      canvas.style.width = (canvas.width*clamped)+'px';
      canvas.style.height = (canvas.height*clamped)+'px';
    }
    function updateFitLabel(){ if(!fitBtn) return; fitBtn.textContent = 'Fit: ' + (fitToWindow ? 'On' : 'Off'); if(fitToWindow){ fitBtn.classList.add('b-cyan'); fitBtn.classList.remove('b-mag'); if(zoomRange) zoomRange.disabled = true; } else { fitBtn.classList.remove('b-cyan'); fitBtn.classList.add('b-mag'); if(zoomRange) zoomRange.disabled = false; } }
    function toggleFit(){ fitToWindow = !fitToWindow; if(!fitToWindow){ zoom = parseFloat(zoomRange.value || '1'); } updateFitLabel(); fit(); }
    if(fitBtn){ fitBtn.addEventListener('click', toggleFit); }
    if(zoomRange){ zoomRange.addEventListener('input', ()=>{ fitToWindow=false; updateFitLabel(); zoom=parseFloat(zoomRange.value); fit(); }); }
    window.addEventListener('resize', fit);
    fit(); updateFitLabel();
  })();
  </script>
</body>
</html>
